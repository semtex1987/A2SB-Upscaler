services:
  upsampler:
    build: .
    image: nvidia_upsample_gradio
    container_name: nvidia_upsample
    
    ports:
      - "7860:7860"
    
    volumes:
      - ./restored_audio:/app/outputs
    
    environment:
      # We keep this because the Python code forces a distributed mode.
      # GLOO ensures it runs on the CPU/RAM side of things, bypassing
      # the "Operation Not Supported" error of your vGPU driver.
      - PL_TORCH_DISTRIBUTED_BACKEND=gloo
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              # FIX: explicitly select GPU 0 by index.
              # This replaces 'count: all' or 'count: 1'
              device_ids: ['0']
              capabilities: [gpu]

    stdin_open: true
    tty: true
